{% extends "base.html" %}

{% block title %}Edit Job Card{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">✏️ Edit Job Card: {{ job_card.job_card_number }}</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_job_card', job_card_id=job_card.id) }}">
                        <!-- Vehicle Info (Read-only) -->
                        <h5 class="border-bottom pb-2 mb-3">Vehicle Information</h5>
                        <div class="alert alert-info">
                            <strong>{{ job_card.vehicle_number }}</strong> - {{ job_card.make }} {{ job_card.model }}
                        </div>

                        <!-- Customer Information -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4">Customer Information</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="customer_name" class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" 
                                       value="{{ job_card.customer_name if job_card.customer_name else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="customer_phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone"
                                       value="{{ job_card.customer_phone if job_card.customer_phone else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="customer_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email"
                                       value="{{ job_card.customer_email if job_card.customer_email else '' }}">
                            </div>
                        </div>

                        <!-- Service Details -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4">Service Details</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="expected_completion" class="form-label">Expected Completion</label>
                                <input type="datetime-local" class="form-control" id="expected_completion" name="expected_completion"
                                       value="{{ job_card.expected_completion.strftime('%Y-%m-%dT%H:%M') if job_card.expected_completion else '' }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="odometer_in" class="form-label">Odometer In (km)</label>
                                <input type="number" class="form-control" id="odometer_in" name="odometer_in"
                                       value="{{ job_card.odometer_in if job_card.odometer_in else '' }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="odometer_out" class="form-label">Odometer Out (km)</label>
                                <input type="number" class="form-control" id="odometer_out" name="odometer_out"
                                       value="{{ job_card.odometer_out if job_card.odometer_out else '' }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="fuel_level" class="form-label">Fuel Level</label>
                                <select class="form-select" id="fuel_level" name="fuel_level">
                                    <option value="">Select fuel level</option>
                                    <option value="Empty" {% if job_card.fuel_level == 'Empty' %}selected{% endif %}>Empty (0%)</option>
                                    <option value="1/4" {% if job_card.fuel_level == '1/4' %}selected{% endif %}>1/4 Tank (25%)</option>
                                    <option value="1/2" {% if job_card.fuel_level == '1/2' %}selected{% endif %}>1/2 Tank (50%)</option>
                                    <option value="3/4" {% if job_card.fuel_level == '3/4' %}selected{% endif %}>3/4 Tank (75%)</option>
                                    <option value="Full" {% if job_card.fuel_level == 'Full' %}selected{% endif %}>Full (100%)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="assigned_technician" class="form-label">Assigned Technician</label>
                                <select class="form-select" id="assigned_technician" name="assigned_technician">
                                    <option value="">Unassigned</option>
                                    {% for tech in technicians %}
                                    <option value="{{ tech.id }}" {% if job_card.assigned_technician == tech.id %}selected{% endif %}>
                                        {{ tech.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="normal" {% if job_card.priority == 'normal' %}selected{% endif %}>Normal</option>
                                    <option value="high" {% if job_card.priority == 'high' %}selected{% endif %}>High</option>
                                    <option value="urgent" {% if job_card.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="status" class="form-label">Status *</label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="open" {% if job_card.status == 'open' %}selected{% endif %}>Open</option>
                                    <option value="in_progress" {% if job_card.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                                    <option value="on_hold" {% if job_card.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                                    <option value="completed" {% if job_card.status == 'completed' %}selected{% endif %}>Completed</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="reported_issues" class="form-label">Reported Issues/Problems *</label>
                            <textarea class="form-control" id="reported_issues" name="reported_issues" rows="3" required>{{ job_card.reported_issues if job_card.reported_issues else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="diagnosis" class="form-label">Diagnosis</label>
                            <textarea class="form-control" id="diagnosis" name="diagnosis" rows="3">{{ job_card.diagnosis if job_card.diagnosis else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="recommended_services" class="form-label">Recommended Services</label>
                            <textarea class="form-control" id="recommended_services" name="recommended_services" rows="3">{{ job_card.recommended_services if job_card.recommended_services else '' }}</textarea>
                        </div>

                        <!-- Costs -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4">Cost Information</h5>
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> Parts cost is automatically calculated from job card items. You can manually enter labor cost.</small>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="labor_cost" class="form-label">Labor Cost ($)</label>
                                <input type="number" step="0.01" class="form-control" id="labor_cost" name="labor_cost"
                                       value="{{ job_card.labor_cost if job_card.labor_cost else '0' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Parts Cost (Calculated)</label>
                                <input type="text" class="form-control" value="${{ '%.2f'|format(job_card.parts_cost) }}" readonly>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Total Cost</label>
                                <input type="text" class="form-control" value="${{ '%.2f'|format(job_card.total_cost) }}" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2">{{ job_card.notes if job_card.notes else '' }}</textarea>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('view_job_card', job_card_id=job_card.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Job Card
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
