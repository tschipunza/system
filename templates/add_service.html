{% extends "base.html" %}

{% block title %}Add Service Record{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        ðŸ”§ Add Service/Maintenance Record
                        {% if requisition %}
                        <span class="badge bg-info ms-2">From Requisition: {{ requisition.requisition_number }}</span>
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    {% if requisition %}
                    <div class="alert alert-info">
                        <strong>Service Requisition Details:</strong><br>
                        <strong>Vehicle:</strong> {{ requisition.vehicle_reg }} - {{ requisition.vehicle_make }} {{ requisition.vehicle_model }}<br>
                        <strong>Requested By:</strong> {{ requisition.requester_name }} ({{ requisition.requester_email }})<br>
                        <strong>Work Description:</strong> {{ requisition.work_description }}
                    </div>
                    <input type="hidden" name="requisition_id" value="{{ requisition.id }}">
                    {% endif %}
                    
                    <form method="POST" action="{{ url_for('add_service') }}{% if requisition %}?requisition_id={{ requisition.id }}{% endif %}" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vehicle_id" class="form-label">Vehicle *</label>
                                <select class="form-select" id="vehicle_id" name="vehicle_id" required>
                                    <option value="">Select a vehicle</option>
                                    {% for vehicle in vehicles %}
                                    <option value="{{ vehicle.id }}" 
                                            data-mileage="{{ vehicle.mileage }}"
                                            data-last-service="{{ vehicle.last_service_date }}"
                                            {% if requisition and vehicle.id == requisition.vehicle_id %}selected{% endif %}>
                                        {{ vehicle.vehicle_number }} - {{ vehicle.make }} {{ vehicle.model }}
                                        (Current: {{ vehicle.mileage if vehicle.mileage else 'N/A' }} km)
                                    </option>
                                    {% endfor %}
                                </select>
                                <small id="vehicle_info" class="text-muted"></small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="service_type" class="form-label">Service Classification *</label>
                                <select class="form-select" id="service_type" name="service_type" required>
                                    <option value="">Select service classification</option>
                                    <optgroup label="ðŸ”§ Scheduled Services">
                                        <option value="A Service (10,000 km)">A Service (10,000 km) - Oil Change & Basic Inspection</option>
                                        <option value="B Service (20,000 km)">B Service (20,000 km) - A Service + Filters & Rotation</option>
                                        <option value="C Service (30,000 km)">C Service (30,000 km) - B Service + Plugs & Brakes</option>
                                        <option value="D Service (40,000 km)">D Service (40,000 km) - Full Service + Diagnostics</option>
                                    </optgroup>
                                    <optgroup label="ðŸ› ï¸ Component Services">
                                        <option value="Oil Change">Oil Change</option>
                                        <option value="Tire Rotation">Tire Rotation</option>
                                        <option value="Brake Service">Brake Service</option>
                                        <option value="Engine Tune-up">Engine Tune-up</option>
                                        <option value="Transmission Service">Transmission Service</option>
                                        <option value="Battery Replacement">Battery Replacement</option>
                                        <option value="Air Filter Replacement">Air Filter Replacement</option>
                                        <option value="Wheel Alignment">Wheel Alignment</option>
                                        <option value="Suspension Service">Suspension Service</option>
                                        <option value="Cooling System Service">Cooling System Service</option>
                                    </optgroup>
                                    <optgroup label="ðŸ” Inspection & Diagnostics">
                                        <option value="Safety Inspection">Safety Inspection</option>
                                        <option value="Diagnostic Scan">Diagnostic Scan</option>
                                        <option value="Pre-Purchase Inspection">Pre-Purchase Inspection</option>
                                    </optgroup>
                                    <optgroup label="ðŸ”¨ Repairs">
                                        <option value="Engine Repair">Engine Repair</option>
                                        <option value="Transmission Repair">Transmission Repair</option>
                                        <option value="Electrical Repair">Electrical Repair</option>
                                        <option value="Body Repair">Body Repair</option>
                                        <option value="General Repair">General Repair</option>
                                    </optgroup>
                                    <optgroup label="ðŸ“‹ Other">
                                        <option value="Recall Service">Recall Service</option>
                                        <option value="Warranty Work">Warranty Work</option>
                                        <option value="Emergency Repair">Emergency Repair</option>
                                        <option value="Other">Other</option>
                                    </optgroup>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    <span id="service_info">Select a service to see details</span>
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="service_date" class="form-label">Service Date *</label>
                                <input type="date" class="form-control" id="service_date" name="service_date" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="cost" class="form-label">Cost ($)</label>
                                <input type="number" step="0.01" class="form-control" id="cost" 
                                       name="cost" placeholder="e.g., 250.00">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="odometer_reading" class="form-label">Odometer Reading (km)</label>
                                <input type="number" class="form-control" id="odometer_reading" 
                                       name="odometer_reading" placeholder="e.g., 12500"
                                       value="{% if requisition %}{{ requisition.current_mileage }}{% endif %}">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="service_provider" class="form-label">Service Provider</label>
                                <input type="text" class="form-control" id="service_provider" 
                                       name="service_provider" placeholder="e.g., ABC Auto Service">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label">Status *</label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="completed" selected>Completed</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="in_progress">In Progress</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="next_service_date" class="form-label">Next Service Date</label>
                                <input type="date" class="form-control" id="next_service_date" name="next_service_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="next_service_mileage" class="form-label">Next Service Mileage (km)</label>
                                <input type="number" class="form-control" id="next_service_mileage" 
                                       name="next_service_mileage" placeholder="e.g., 15000">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Service Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="Describe the service performed...">{% if requisition %}{{ requisition.work_description }}{% endif %}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="parts_replaced" class="form-label">Parts Replaced</label>
                            <textarea class="form-control" id="parts_replaced" name="parts_replaced" rows="2" 
                                      placeholder="List parts that were replaced..."></textarea>
                        </div>

                        {% if requisition and requisition.service_history %}
                        <div class="mb-3">
                            <label class="form-label">Requisition Service History</label>
                            <div class="alert alert-secondary">
                                {{ requisition.service_history }}
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="invoice" class="form-label">Invoice/Receipt (PNG, JPG, JPEG, PDF - Max 16MB)</label>
                            <input type="file" class="form-control" id="invoice" name="invoice" 
                                   accept=".png,.jpg,.jpeg,.pdf">
                            <small class="text-muted">Upload service invoice or receipt</small>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" 
                                      placeholder="Any additional notes..."></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('service_maintenance') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Service Record
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Set today's date as default
    document.getElementById('service_date').valueAsDate = new Date();
    
    // Service details information
    const serviceDetails = {
        'A Service (10,000 km)': 'âœ“ Engine oil & filter change âœ“ Safety inspection âœ“ Fluid level checks',
        'B Service (20,000 km)': 'âœ“ All A Service tasks âœ“ Air & cabin filter replacement âœ“ Tire rotation âœ“ Battery check',
        'C Service (30,000 km)': 'âœ“ All A & B Service tasks âœ“ Spark plugs âœ“ Brake inspection âœ“ Transmission fluid âœ“ Suspension check',
        'D Service (40,000 km)': 'âœ“ All A, B & C Service tasks âœ“ Timing belt/chain âœ“ Full diagnostic âœ“ Cooling system flush âœ“ Comprehensive health check'
    };
    
    // Show vehicle info when selected
    document.getElementById('vehicle_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const mileage = selectedOption.getAttribute('data-mileage');
        const lastService = selectedOption.getAttribute('data-last-service');
        const info = document.getElementById('vehicle_info');
        
        if (mileage && mileage !== 'None') {
            let infoText = `Current mileage: ${mileage} km`;
            if (lastService && lastService !== 'None') {
                infoText += ` | Last service: ${lastService}`;
            }
            info.textContent = infoText;
            info.classList.add('text-info');
        } else {
            info.textContent = '';
        }
    });
    
    // Show service details when service type is selected
    document.getElementById('service_type').addEventListener('change', function() {
        const serviceInfo = document.getElementById('service_info');
        const selectedValue = this.value;
        
        if (serviceDetails[selectedValue]) {
            serviceInfo.innerHTML = '<strong>' + serviceDetails[selectedValue] + '</strong>';
            serviceInfo.className = 'form-text text-success';
        } else {
            serviceInfo.innerHTML = '<i class="fas fa-info-circle"></i> Select a service to see details';
            serviceInfo.className = 'form-text text-muted';
        }
    });
</script>
{% endblock %}
