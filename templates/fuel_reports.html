{% extends "base.html" %}

{% block title %}Fuel Reports{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-graph-up"></i> Fuel Reports</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('employee_dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Fuel Reports</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ url_for('fuel_exceptions_report') }}" class="btn btn-warning">
                        <i class="fas fa-exclamation-triangle"></i> Fuel Exceptions
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Report Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('fuel_reports') }}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="report_type" class="form-label">Report Type</label>
                        <select class="form-select" id="report_type" name="report_type" onchange="toggleCustomDates()">
                            <option value="weekly" {% if report_type == 'weekly' %}selected{% endif %}>This Week</option>
                            <option value="monthly" {% if report_type == 'monthly' %}selected{% endif %}>This Month</option>
                            <option value="quarterly" {% if report_type == 'quarterly' %}selected{% endif %}>This Quarter</option>
                            <option value="custom" {% if report_type == 'custom' %}selected{% endif %}>Custom Range</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3" id="start_date_div" style="display: {% if report_type == 'custom' %}block{% else %}none{% endif %};">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
                    </div>
                    
                    <div class="col-md-3" id="end_date_div" style="display: {% if report_type == 'custom' %}block{% else %}none{% endif %};">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
                    </div>
                    
                    <div class="col-md-3">
                        <label for="vehicle_filter" class="form-label">Filter by Vehicle</label>
                        <select class="form-select" id="vehicle_filter" name="vehicle_filter">
                            <option value="">All Vehicles</option>
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.id }}" {% if vehicle_filter|string == vehicle.id|string %}selected{% endif %}>
                                {{ vehicle.vehicle_number }} - {{ vehicle.make }} {{ vehicle.model }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="driver_filter" class="form-label">Filter by Driver</label>
                        <select class="form-select" id="driver_filter" name="driver_filter">
                            <option value="">All Drivers</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}" {% if driver_filter|string == employee.id|string %}selected{% endif %}>
                                {{ employee.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Generate Report
                        </button>
                        <a href="{{ url_for('fuel_reports') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </a>
                        <a href="{{ url_for('fuel_reports_print', report_type=report_type, vehicle_filter=vehicle_filter, driver_filter=driver_filter, start_date=start_date, end_date=end_date) }}" 
                           class="btn btn-success" target="_blank">
                            <i class="bi bi-printer"></i> Print Report
                        </a>
                        <a href="{{ url_for('fuel_reports_export', report_type=report_type, vehicle_filter=vehicle_filter, driver_filter=driver_filter, start_date=start_date, end_date=end_date) }}" 
                           class="btn btn-info">
                            <i class="bi bi-file-earmark-excel"></i> Export to Excel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Records</h6>
                    <h3 class="mb-0">{{ summary.total_records }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Litres</h6>
                    <h3 class="mb-0">{{ "%.2f"|format(summary.total_litres) }} L</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Total Cost</h6>
                    <h3 class="mb-0">${{ "%.2f"|format(summary.total_cost) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h6 class="card-title">Avg Cost/Litre</h6>
                    <h3 class="mb-0">${{ "%.2f"|format(summary.avg_cost_per_litre) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Period -->
    <div class="alert alert-info">
        <strong>Report Period:</strong> {{ start_date }} to {{ end_date }}
        {% if vehicle_filter %}
        | <strong>Vehicle:</strong> 
        {% for v in vehicles %}
            {% if v.id|string == vehicle_filter %}{{ v.vehicle_number }}{% endif %}
        {% endfor %}
        {% endif %}
        {% if driver_filter %}
        | <strong>Driver:</strong> 
        {% for e in employees %}
            {% if e.id|string == driver_filter %}{{ e.username }}{% endif %}
        {% endfor %}
        {% endif %}
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">
                <i class="bi bi-pie-chart"></i> Summary
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="vehicle-tab" data-bs-toggle="tab" data-bs-target="#vehicle" type="button" role="tab">
                <i class="bi bi-truck"></i> By Vehicle
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="driver-tab" data-bs-toggle="tab" data-bs-target="#driver" type="button" role="tab">
                <i class="bi bi-person"></i> By Driver
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                <i class="bi bi-list-ul"></i> Detailed Records
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="reportTabsContent">
        <!-- Summary Tab -->
        <div class="tab-pane fade show active" id="summary" role="tabpanel">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Overall Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-bordered">
                                <tr>
                                    <th width="50%">Total Fuel Records:</th>
                                    <td><strong>{{ summary.total_records }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Total Litres Consumed:</th>
                                    <td><strong>{{ "%.2f"|format(summary.total_litres) }} L</strong></td>
                                </tr>
                                <tr>
                                    <th>Total Cost:</th>
                                    <td><strong>${{ "%.2f"|format(summary.total_cost) }}</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-bordered">
                                <tr>
                                    <th width="50%">Average Cost per Litre:</th>
                                    <td><strong>${{ "%.2f"|format(summary.avg_cost_per_litre) }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Average Litres per Fill:</th>
                                    <td><strong>{{ "%.2f"|format(summary.avg_litres_per_fill) }} L</strong></td>
                                </tr>
                                <tr>
                                    <th>Vehicles Tracked:</th>
                                    <td><strong>{{ vehicles_summary|length }}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Summary Tab -->
        <!-- Vehicle Summary Tab -->
        <div class="tab-pane fade" id="vehicle" role="tabpanel">
    {% if vehicles_summary %}
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-truck"></i> Summary by Vehicle</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Vehicle</th>
                            <th>Make/Model</th>
                            <th class="text-end">Fill Count</th>
                            <th class="text-end">Total Litres</th>
                            <th class="text-end">Total Cost</th>
                            <th class="text-end">Distance (km)</th>
                            <th class="text-end">L/100km</th>
                            <th class="text-end">Avg Cost/Fill</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vid, vdata in vehicles_summary.items() %}
                        <tr>
                            <td><strong>{{ vdata.vehicle_number }}</strong></td>
                            <td>{{ vdata.make }} {{ vdata.model }}</td>
                            <td class="text-end">{{ vdata.fill_count }}</td>
                            <td class="text-end">{{ "%.2f"|format(vdata.total_litres) }} L</td>
                            <td class="text-end">${{ "%.2f"|format(vdata.total_cost) }}</td>
                            <td class="text-end">{{ "{:,}".format(vdata.total_km) if vdata.total_km > 0 else 'N/A' }}</td>
                            <td class="text-end">
                                {% if vdata.avg_consumption > 0 %}
                                    {{ "%.2f"|format(vdata.avg_consumption) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="text-end">${{ "%.2f"|format(vdata.total_cost / vdata.fill_count) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
        </div>

        <!-- Driver Summary Tab -->
        <div class="tab-pane fade" id="driver" role="tabpanel">
    {% if drivers_summary %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-person"></i> Summary by Driver</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Driver</th>
                            <th class="text-end">Fill Count</th>
                            <th class="text-end">Total Litres</th>
                            <th class="text-end">Total Cost</th>
                            <th class="text-end">Distance (km)</th>
                            <th class="text-end">L/100km</th>
                            <th class="text-end">Avg Cost/Fill</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for did, ddata in drivers_summary.items() %}
                        <tr>
                            <td><strong>{{ ddata.driver_name }}</strong></td>
                            <td class="text-end">{{ ddata.fill_count }}</td>
                            <td class="text-end">{{ "%.2f"|format(ddata.total_litres) }} L</td>
                            <td class="text-end">${{ "%.2f"|format(ddata.total_cost) }}</td>
                            <td class="text-end">{{ "{:,}".format(ddata.total_km) if ddata.total_km > 0 else 'N/A' }}</td>
                            <td class="text-end">
                                {% if ddata.avg_consumption > 0 %}
                                    {{ "%.2f"|format(ddata.avg_consumption) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="text-end">${{ "%.2f"|format(ddata.total_cost / ddata.fill_count) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
        </div>

        <!-- Detailed Records Tab -->
        <div class="tab-pane fade" id="details" role="tabpanel">
    <!-- Detailed Records -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Detailed Fuel Records</h5>
        </div>
        <div class="card-body">
            {% if fuel_records %}
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Vehicle</th>
                            <th>Driver</th>
                            <th>Fuel Station</th>
                            <th class="text-end">Odometer</th>
                            <th class="text-end">Distance</th>
                            <th class="text-end">Litres</th>
                            <th class="text-end">L/100km</th>
                            <th class="text-end">Price/L</th>
                            <th class="text-end">Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in fuel_records %}
                        <tr>
                            <td>{{ record.fuel_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ record.vehicle_number }}</td>
                            <td>{{ record.driver_name }}</td>
                            <td>{{ record.station_name if record.station_name else 'N/A' }}</td>
                            <td class="text-end">{{ "{:,}".format(record.odometer_reading) if record.odometer_reading else 'N/A' }} km</td>
                            <td class="text-end">
                                {% if record.distance_since_last %}
                                    {{ "{:,}".format(record.distance_since_last) }} km
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">{{ "%.2f"|format(record.fuel_amount) }} L</td>
                            <td class="text-end">
                                {% if record.consumption %}
                                    <span class="badge {% if record.consumption > 15 %}bg-danger{% elif record.consumption > 10 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ "%.2f"|format(record.consumption) }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">${{ "%.2f"|format(record.fuel_cost / record.fuel_amount) }}</td>
                            <td class="text-end">${{ "%.2f"|format(record.fuel_cost) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No fuel records found for the selected period and filters.
            </div>
            {% endif %}
        </div>
    </div>
        </div>
    </div>
</div>

<script>
function toggleCustomDates() {
    var reportType = document.getElementById('report_type').value;
    var startDiv = document.getElementById('start_date_div');
    var endDiv = document.getElementById('end_date_div');
    
    if (reportType === 'custom') {
        startDiv.style.display = 'block';
        endDiv.style.display = 'block';
    } else {
        startDiv.style.display = 'none';
        endDiv.style.display = 'none';
    }
}
</script>
{% endblock %}
