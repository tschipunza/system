{% extends 'base.html' %}

{% block title %}Audit Trail - Fleet Management System{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics-mobile.css') }}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<style>
    .audit-filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
    }
    
    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: end;
    }
    
    .audit-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .audit-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .audit-table thead {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    .audit-table th {
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    
    .audit-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
    }
    
    .audit-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .action-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .action-view_dashboard { background: #e3f2fd; color: #1976d2; }
    .action-view_report { background: #e8f5e9; color: #388e3c; }
    .action-export_excel { background: #fff3e0; color: #f57c00; }
    .action-export_pdf { background: #fce4ec; color: #c2185b; }
    .action-create_scheduled_report { background: #f3e5f5; color: #7b1fa2; }
    .action-delete_scheduled_report { background: #ffebee; color: #d32f2f; }
    .action-run_scheduled_report { background: #e0f2f1; color: #00796b; }
    
    .execution-time {
        color: #666;
        font-size: 12px;
    }
    
    .execution-fast { color: #4caf50; }
    .execution-medium { color: #ff9800; }
    .execution-slow { color: #f44336; }
    
    .details-json {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #666;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        padding: 20px;
    }
    
    .pagination button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .pagination button:hover:not(:disabled) {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .pagination .page-info {
        font-size: 14px;
        color: #666;
    }
    
    .export-btn {
        background: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: background 0.2s;
    }
    
    .export-btn:hover {
        background: #218838;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .summary-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .summary-card .number {
        font-size: 32px;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
    }
    
    .summary-card .label {
        font-size: 14px;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-shield-alt"></i> Audit Trail</h2>
        <button class="export-btn" onclick="exportAuditLog()">
            <i class="fas fa-download"></i> Export to Excel
        </button>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-cards" id="summaryCards">
        <div class="summary-card">
            <div class="number" id="totalActions">-</div>
            <div class="label">Total Actions</div>
        </div>
        <div class="summary-card">
            <div class="number" id="uniqueUsers">-</div>
            <div class="label">Active Users</div>
        </div>
        <div class="summary-card">
            <div class="number" id="avgExecutionTime">-</div>
            <div class="label">Avg Response Time (ms)</div>
        </div>
        <div class="summary-card">
            <div class="number" id="todayActions">-</div>
            <div class="label">Actions Today</div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="audit-filters">
        <div class="filter-row">
            <div class="filter-group">
                <label>Start Date</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="filter-group">
                <label>End Date</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="filter-group">
                <label>Action Type</label>
                <select id="actionType" class="form-control">
                    <option value="">All Actions</option>
                    <option value="view_dashboard">View Dashboard</option>
                    <option value="view_report">View Report</option>
                    <option value="export_excel">Export Excel</option>
                    <option value="export_pdf">Export PDF</option>
                    <option value="create_scheduled_report">Create Scheduled Report</option>
                    <option value="delete_scheduled_report">Delete Scheduled Report</option>
                    <option value="run_scheduled_report">Run Scheduled Report</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Employee</label>
                <select id="employeeId" class="form-control">
                    <option value="">All Employees</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="loadAuditLog()">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>
    </div>
    
    <!-- Audit Log Table -->
    <div class="audit-table">
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Employee</th>
                    <th>Action</th>
                    <th>Resource</th>
                    <th>Details</th>
                    <th>Execution Time</th>
                    <th>IP Address</th>
                </tr>
            </thead>
            <tbody id="auditTableBody">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Loading audit log...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="pagination">
        <button id="prevBtn" onclick="previousPage()" disabled>
            <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span class="page-info" id="pageInfo">Page 1</span>
        <button id="nextBtn" onclick="nextPage()">
            Next <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<script>
let currentPage = 1;
const pageSize = 50;
let totalPages = 1;

// Set default dates (last 7 days)
window.onload = function() {
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = weekAgo;
    
    loadSummary();
    loadAuditLog();
};

async function loadSummary() {
    try {
        const response = await fetch('/analytics/api/audit-summary?days=30');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalActions').textContent = data.total_actions.toLocaleString();
            document.getElementById('uniqueUsers').textContent = data.unique_users;
            document.getElementById('avgExecutionTime').textContent = Math.round(data.avg_execution_time);
            document.getElementById('todayActions').textContent = data.today_actions.toLocaleString();
        }
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

async function loadAuditLog() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const actionType = document.getElementById('actionType').value;
    const employeeId = document.getElementById('employeeId').value;
    
    const params = new URLSearchParams({
        page: currentPage,
        page_size: pageSize
    });
    
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (actionType) params.append('action_type', actionType);
    if (employeeId) params.append('employee_id', employeeId);
    
    try {
        const response = await fetch(`/analytics/api/audit-log?${params}`);
        const data = await response.json();
        
        if (data.success) {
            renderAuditLog(data.logs);
            updatePagination(data.total, data.page, data.page_size);
        } else {
            showError('Failed to load audit log');
        }
    } catch (error) {
        showError('Error loading audit log: ' + error.message);
    }
}

function renderAuditLog(logs) {
    const tbody = document.getElementById('auditTableBody');
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px;">
                    <i class="fas fa-inbox fa-2x" style="color: #ccc;"></i>
                    <p class="mt-2">No audit logs found for the selected filters</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = logs.map(log => {
        const executionClass = log.execution_time_ms 
            ? (log.execution_time_ms < 500 ? 'execution-fast' : log.execution_time_ms < 2000 ? 'execution-medium' : 'execution-slow')
            : '';
        
        const detailsText = log.details 
            ? (typeof log.details === 'string' ? log.details : JSON.stringify(log.details))
            : '-';
        
        return `
            <tr>
                <td>${formatTimestamp(log.created_at)}</td>
                <td>${log.username || 'Unknown'}</td>
                <td><span class="action-badge action-${log.action_type}">${formatActionType(log.action_type)}</span></td>
                <td>${log.resource_type || '-'}${log.resource_id ? ' #' + log.resource_id : ''}</td>
                <td><span class="details-json" title="${detailsText}">${detailsText}</span></td>
                <td class="execution-time ${executionClass}">
                    ${log.execution_time_ms ? log.execution_time_ms + ' ms' : '-'}
                </td>
                <td>${log.ip_address || '-'}</td>
            </tr>
        `;
    }).join('');
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatActionType(action) {
    return action.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function updatePagination(total, page, pageSize) {
    totalPages = Math.ceil(total / pageSize);
    currentPage = page;
    
    document.getElementById('pageInfo').textContent = 
        `Page ${currentPage} of ${totalPages} (${total} records)`;
    
    document.getElementById('prevBtn').disabled = currentPage <= 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        loadAuditLog();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        loadAuditLog();
    }
}

function resetFilters() {
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = weekAgo;
    document.getElementById('actionType').value = '';
    document.getElementById('employeeId').value = '';
    
    currentPage = 1;
    loadAuditLog();
}

async function exportAuditLog() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const actionType = document.getElementById('actionType').value;
    const employeeId = document.getElementById('employeeId').value;
    
    const params = new URLSearchParams();
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    if (actionType) params.append('action_type', actionType);
    if (employeeId) params.append('employee_id', employeeId);
    
    window.location.href = `/analytics/api/audit-log/export?${params}`;
}

function showError(message) {
    const tbody = document.getElementById('auditTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #d32f2f;">
                <i class="fas fa-exclamation-circle fa-2x"></i>
                <p class="mt-2">${message}</p>
            </td>
        </tr>
    `;
}
</script>
{% endblock %}
